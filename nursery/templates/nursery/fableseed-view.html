<!-- Template for displaying a single Fableseed post and its Fablebranch replies. Includes delete modals and user-specific edit/delete controls. -->
{% extends 'base.html' %}
{% load static %}
<!-- Dynamically sets the page title based on the Fableseed number -->
{% block title %}
Title: {{fableseed.title}}
{% endblock %}

{% block content %}
<!-- Delete confirmation modal for all Fableseed and Fablebranch delete buttons -->
<dialog id="delete-message" class="modal">
    <div class="modal-box bg-warning">
        <h3 class="text-lg font-bold text-warning-content 2xl:text-3xl">Warning</h3>
        <p class="py-4 2xl:py-6 text-warning-content 2xl:text-2xl">Are you sure you want to delete? This action cannot
            be undone.</p>
        <div class="modal-action 2xl:gap-4">
            <form method="dialog">
                <button class="btn 2xl:btn-xl hover:bg-secondary hover:text-secondary-content">Close</button>
            </form>
            <a class="btn 2xl:btn-xl hover:bg-secondary hover:text-secondary-content" id="delete-confirm">Confirm</a>
        </div>
    </div>
</dialog>
<!-- Main Fableseed post view including title, body, author details and controls in a grid layout with main post at top and branches below -->
<section class="grid grid-flow-row gap-4 mb-4">
    <!-- Fableseed title and image for the page -->
    <div class="flex items-center justify-center gap-2 flex-col text-center md:flex-row">
        <h2 class="text-4xl order-2 2xl:text-5xl 2xl:mb-4 2xl:mt-4">{{ fableseed.title }}</h2>
        <img src="{{ fableseed.flower_type.flower_image.url }}" alt="{{ fableseed.flower_type.flower_name }}"
            height="50" width="50" class="h-12 w-12 2xl:h-20 2xl:w-20 order-1">
    </div>
    <article
        class="grid sm:grid-flow-row md:grid-flow-col md:grid-cols-[200px_1fr] md:gap-4 w-full h-full overflow-auto bg-base-100 text-primary-content rounded-xl bg-clip-border drop-shadow-secondary-content drop-shadow-md container p-4">
        <!-- Main Fableseed post content including author info, creation date, title, body, and flower image -->
        <div
            class="row-span-12 border-1 border-primary-content rounded-xl sm:p-2 max-h-80 flex flex-4 flex-col items-center justify-between">
            <p class="md:text-center font-bold mb-4 mt-4 2xl:text-2xl">{{ fableseed.author.get_display_name }}</p>
            <img src="{{fableseed.author.userprofile.user_profile_image_url}}"
                alt="{{fableseed.author.get_display_name}}" width="150" height="150"
                class="w-[150px] h-[150px] object-cover">
            <p class="md:text-center mt-4 mb-4">{{ fableseed.author.userprofile.bio }}</p>
        </div>
        <span
            class="md:col-span-10 border-b-2 pb-2 mt-5 md:mt-0 italic text-sm 2xl:text-xl">{{ fableseed.created_on|date:"F jS, Y, g:i a" }}</span>
        <div class="md:col-span-10 md:row-span-10 mb-4">
            <h3 class="font-bold text-lg md:text-xl pb-2 pt-4 md:pt-0 2xl:text-3xl">{{ fableseed.title }}</h3>
            <p class="2xl:text-2xl">{{ fableseed.body }}</p>
        </div>
        <!-- Author-specific controls (edit/delete) shown only if current user is the author -->
        <div id="fableseed-btns"
            class="md:col-span-10 flex mx-auto sm:mx-0 justify-center sm:justify-end gap-2 mt-4 flex-row">
            {% if user.is_authenticated and user == fableseed.author %}
            <a href="{% url 'edit-fableseed' fableseed.seed %}"
                class="btn 2xl:btn-lg hover:bg-secondary hover:text-secondary-content edit">Tend Seed</a>
            <button class="btn 2xl:btn-lg hover:bg-red-700 hover:text-primary-content delete"
                data-id="{{fableseed.seed}}" data-type="seed">Prune Seed</button>
            {% endif %}
        </div>
    </article>
    <!-- Iterates through all branches (replies) associated with this Fableseed, styles odd and even branch replies alternating colours. -->
    {% if posted_branches %}
    {% for branch in posted_branches %}
    <article
        class="grid sm:grid-flow-row md:grid-flow-col md:grid-cols-[200px_1fr] md:gap-4 w-full h-full overflow-auto odd:bg-primary-content odd:text-base-300 even:bg-secondary-content rounded-xl bg-clip-border odd:drop-shadow-secondary-content even:drop-shadow-primary-content drop-shadow-md container p-4">
        <!-- Odd/even classes alternate background and border colors for readability using forloop.counter -->
        <div
            class="md:row-span-12 border-1 {% if forloop.counter|divisibleby:2 %}border-primary-content{% else %} border-base-300 {% endif %} rounded-xl sm:p-2 max-h-80 flex flex-col items-center justify-between">
            <p class="md:text-center font-bold pb-4 mt-4 2xl:text-2xl">{{ branch.author.get_display_name }}</p>
            <img src="{{branch.author.userprofile.user_profile_image_url}}" alt="{{branch.author.get_display_name}}"
                width="150" height="150" class="w-[150px] h-[150px] object-cover">
            <p class="md:text-center mt-4 mb-4">{{ fableseed.author.userprofile.bio }}</p>
        </div>
        <span class="md:col-span-10 border-b-2 mt-4 md:mt-0 pb-2 italic text-sm 2xl:text-xl">
            {{ branch.created_on|date:"F jS, Y, g:i a" }}
        </span>
        <div class="md:col-span-10 md:row-span-10 mb-4 w-full">
            <h3 class="font-bold text-lg md:text-xl pb-2 pt-4 md:pt-0 italic 2xl:text-3xl">Re: {{ fableseed.title }}
            </h3>
            <p class="break-words 2xl:text-2xl">{{ branch.body }}</p>
        </div>
        <div class="md:col-span-10 flex mx-auto sm:mx-0 justify-center sm:justify-end gap-2 mt-4 flex-row">
            {% if user.is_authenticated and user == branch.author %}
            <!-- Show 'Tend Branch' and 'Prune Branch' buttons only to the author of each branch -->
            <a href="{% url 'edit-fablebranch' branch.branch %}"
                class="btn 2xl:btn-lg hover:bg-secondary hover:text-secondary-content">Tend Branch</a>
            <button class="btn 2xl:btn-lg hover:bg-red-700 hover:text-primary-content delete"
                data-id="{{branch.branch}}" data-type="branch">Prune Branch</button>
            {% endif %}
        </div>
    </article>
    {% endfor %}
    {% else %}
    <!-- Display a message if no Fablebranch replies exist yet -->
    <p class="text-center">No branches have grown yet. Be the first to respond!</p>
    {% endif %}
    {% if can_grow %}
    <!-- Show button to grow a new Fablebranch only to logged-in users -->
    <div class="column mx-auto 2xl:mt-4"><a href="{% url 'grow-fablebranch' fableseed.seed %}"
            class="btn 2xl:btn-xl hover:bg-secondary hover:text-secondary-content border-1 border-base-100 shadow-[0px_0px_20px_5px_rgba(85,166,5,0.6)] hover:shadow-[0px_0px_20px_10px_rgba(64,14,55,1)]">Grow
            a Fablebranch</a></div>{% endif %}
</section>
{% endblock content %}