<!-- Template for displaying a single Fableseed post and its Fablebranch replies. Includes delete modals and user-specific edit/delete controls. -->
{% extends 'base.html' %}
{% load static %}
<!-- Dynamically sets the page title based on the Fableseed number -->
{% block title %}
Title: {{fableseed.title}}
{% endblock %}

{% block content %}
<!-- Delete confirmation modal for all Fableseed and Fablebranch delete buttons -->
<dialog id="delete-message" class="modal">
    <div class="modal-box bg-warning">
        <h3 class="text-lg font-bold text-warning-content">Warning</h3>
        <p class="py-4 text-warning-content">Are you sure you want to delete? This action cannot be undone.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn hover:bg-secondary hover:text-secondary-content">Close</button>
            </form>
            <a class="btn hover:bg-secondary hover:text-secondary-content" id="delete-confirm">Confirm</a>
        </div>
    </div>
</dialog>
<!-- Main Fableseed post including title, body, author details and controls -->
<section class="grid grid-flow-row gap-4 mb-4">
<div class="flex items-center justify-center gap-2 flex-col text-center md:flex-row">
  <h2 class="text-4xl font-merriweather">{{ fableseed.title }}</h2>
  <img src="{{ fableseed.flower_type.flower_image.url }}"
       alt="{{ fableseed.flower_type.flower_name }}"
       height="50" width="50" class="h-12 w-12">
</div>
    <article
        class="grid sm:grid-flow-row md:grid-flow-col md:grid-cols-[200px_1fr] md:gap-4 w-full h-full overflow-auto bg-base-100 text-primary-content rounded-xl bg-clip-border drop-shadow-secondary-content drop-shadow-md container p-4">
        <!-- Main Fableseed post content including author info, creation date, title, body, and flower image -->
        <div
            class="row-span-12 sm:border-1 border-primary-content rounded-xl sm:p-2 max-h-80 flex flex-4 flex-col items-center justify-between">
            <p class="md:text-center font-bold mb-4">{{ fableseed.author.get_display_name }}</p>
            <img src="{{fableseed.author.userprofile.user_profile_image_url}}"
                alt="{{fableseed.author.get_display_name}}" width="150" height="150" class="w-[150px] h-[150px] object-cover">
            <p class="md:text-center mt-4">{{ fableseed.author.userprofile.bio }}</p>
        </div>
        
        <span
            class="md:col-span-10 border-b-2 pb-2 mt-5 md:mt-0 italic text-sm">{{ fableseed.created_on|date:"F jS, Y, g:i a" }}</span>
        <div class="md:col-span-10 md:row-span-10 mb-4">
            <h2 class="font-bold md:text-xl pb-2 pt-4 md:pt-0">{{ fableseed.title }}</h2>
            <p>{{ fableseed.body }}</p>
        </div>

        <div id="fableseed-btns"
            class="md:col-span-10 flex mx-auto sm:mx-0 justify-center sm:justify-end gap-2 mt-4 flex-col sm:flex-row">
            {% if user.is_authenticated and user == fableseed.author %}
            <a href="{% url 'edit-fableseed' fableseed.seed %}"
                class="btn hover:bg-secondary hover:text-secondary-content edit">Tend Seed</a>
            <button class="btn hover:bg-red-700 hover:text-primary-content delete" data-id="{{fableseed.seed}}"
                data-type="seed">Prune Seed</button>
            {% endif %}
        </div>
    </article>

<!-- Section that contains all Fablebranch replies to the Fableseed post -->
    <!-- Iterates through all branches (replies) associated with this Fableseed, styles odd and even branch replies alternating colours. -->
    {% if posted_branches %}
    {% for branch in posted_branches %}
    <article
        class="grid sm:grid-flow-row md:grid-flow-col md:grid-cols-[200px_1fr] md:gap-4 w-full h-full overflow-auto odd:bg-primary-content odd:text-base-300 even:bg-secondary-content rounded-xl bg-clip-border odd:drop-shadow-secondary-content even:drop-shadow-primary-content drop-shadow-md container p-4">
        <!-- Uses forloop counter logic to change the border colour in keeping with the alternating background colours-->
        <div
            class="md:row-span-12 sm:border-1 {% if forloop.counter|divisibleby:2 %}border-primary-content{% else %} border-base-300 {% endif %} rounded-xl sm:p-2 max-h-80 flex flex-col items-center justify-between">
            <p class="md:text-center font-bold pb-4">{{ branch.author.get_display_name }}</p>
            <img src="{{branch.author.userprofile.user_profile_image_url}}" alt="{{branch.author.get_display_name}}"
                width="150" height="150" class="w-[150px] h-[150px] object-cover">
            <p class="md:text-center mt-4">{{ fableseed.author.userprofile.bio }}</p>
        </div>
        <span class="md:col-span-10 border-b-2 mt-4 md:mt-0 pb-2 italic text-sm">
            {{ branch.created_on|date:"F jS, Y, g:i a" }}
        </span>
        <div class="md:col-span-10 md:row-span-10 mb-4 w-full">
            <h2 class="font-bold md:text-xl pb-2 pt-4 md:pt-0 italic">Re: {{ fableseed.title }}</h2>
            <p class="break-words">{{ branch.body }}</p>
        </div>
        <div class="md:col-span-10 flex mx-auto sm:mx-0 justify-center sm:justify-end gap-2 mt-4 flex-col sm:flex-row">
            {% if user.is_authenticated and user == branch.author %}
            <!-- Show edit and delete buttons only to the author of this Fablebranch -->
            <a href="{% url 'edit-fablebranch' branch.branch %}"
                class="btn hover:bg-secondary hover:text-secondary-content">Tend Branch</a>
            <button class="btn hover:bg-red-700 hover:text-primary-content delete" data-id="{{branch.branch}}"
                data-type="branch">Prune Branch</button>
            {% endif %}
        </div>
    </article>
    {% endfor %}
    {% else %}
    <!-- Display a message if no Fablebranch replies exist yet -->
    <p class="text-center">No branches have grown yet. Be the first to respond!</p>
    {% endif %}
    {% if user.is_authenticated %}
    <!-- Show button to grow a new Fablebranch only to logged-in users -->
    <div class="column mx-auto"><a href="{% url 'grow-fablebranch' fableseed.seed %}"
            class="btn hover:bg-secondary hover:text-secondary-content border-1 border-base-100 shadow-[0px_0px_20px_5px_rgba(85,166,5,0.6)] hover:shadow-[0px_0px_20px_10px_rgba(64,14,55,1)]">Grow
            a Fablebranch</a></div>{% endif %}
</div>
{% endblock content %}